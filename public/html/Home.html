<!DOCTYPE html>
<html>
  <head>
    <title>URL Shortener</title>
    <link rel="stylesheet" href="../css/home.css" />
  </head>
  <body>
    <h1>URL Shortener</h1>
    <form action="/shortUrl/shorts" method="POST">
      <label for="longURL">Original URL:</label>
      <input type="text" id="longURL" name="longURL" required />
      <br />
      <label for="customURL">Custom URL (optional):</label>
      <input type="text" id="customURL" name="customURL" />
      <br />
      <button type="submit">Generate Short URL</button>
    </form>
    <div>
      <h2>Shortened URL:</h2>
      <table>
        <thead>
          <tr>
            <th>Long URL</th>
            <th>Short URL</th>
            <th>Custom URL</th>
            <th>Visits</th>
            <th>Generate QR Code</th>
          </tr>
        </thead>
        <tbody id="shortURLTableBody">
          <!-- Rows will be dynamically added here -->
        </tbody>
      </table>
    </div>
    <script>
      const shortURLTableBody = document.getElementById("shortURLTableBody");
      shortURLTableBody.addEventListener("click", async function (event) {
        if (event.target.classList.contains("generate-qr-button")) {
          const shortURL = event.target
            .closest("tr")
            .querySelector("td:nth-child(1)").textContent;
          console.log(shortURL);
          const response = await fetch("/shortUrl/generateQrCode", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ text: shortURL }),
          });

          if (response.ok) {
            const qrCodeDataUrl = await response.text();
            console.log(qrCodeDataUrl);
  
            // Create a download button for the QR code image
            const downloadButton = document.createElement("button");
            downloadButton.textContent = "Download QR Code";
            downloadButton.classList.add("download-qr-button");

            // Add a click event listener to initiate the download
            downloadButton.addEventListener("click", function () {
              // Create a download link for the QR code image
              const link = document.createElement("a");
              link.href = qrCodeDataUrl;
              link.download = "qrcode.png";

              // Trigger a click event on the download link to initiate the download
              link.dispatchEvent(new MouseEvent("click"));
            });

            // Replace the "Generate QR Code" button with the download button
            const tableRow = event.target.closest("tr");
            const generateQRCodeCell =
              tableRow.querySelector("td:nth-child(5)");
            generateQRCodeCell.innerHTML = ""; // Clear the cell content
            generateQRCodeCell.appendChild(downloadButton);
          } else {
            console.error("Error generating QR code:", response.status);
          }
        }
      });
    </script>
  </body>
</html>
